var scrollTop=0;$(function(){$("div.split-pane").splitPane(),$("div.split-pane").children(".split-pane-divider").on("touchstart mousedown",function(t){$(".pcst").hide()}),$(document).on("mouseup",function(t){$(".pcst").show()});var t=$(window).height();if($(".split-pane-frame").css("height",t-80),$("#output").css("height",t-307),$("#html").css("height",t-307),$("#text").css("height",t-307),$(window).on("resize",function(){var t=$(window).height();$(".split-pane-frame").css("height",t-80),$("#output").css("height",t-307),$("#html").css("height",t-307),$("#text").css("height",t-307),$("div.split-pane").splitPane("firstComponentSize",$("#left-component").width())}),Object.keys(__contextMenu).length>0){$.contextMenu({selector:".context-menu-one",className:"css-title",zIndex:10,events:{},callback:function(t,e){context.current_editor.replaceRange(t,context.current_editor.getCursor()),context.current_editor.focus()},build:function(t,e){return{items:(o=$.extend(!0,{},__contextMenu),"1"!=formData.ranking_flag&&delete o.group_ranking,o)};var o}})}$.observe(context.data,"main_contents","block_num.*","mail_type",function(t,e){var o=$("body,html",$("iframe").contents()).scrollTop();0!=o&&null!=o&&(scrollTop=o);try{if(void 0===context.editor[context.data.mail_type+"_editor"])return;$.templates({contentsTemplate:replaceKeyword(context.editor[context.data.mail_type+"_editor"].getValue())});var n=$.render.contentsTemplate(context.data);"text"==context.data.mail_type&&(n='<span style="white-space: pre-line;">'+$("<span/>").text(n).html()+"</span>"),$.observable(context.data).setProperty("built_contents",n)}catch(t){$.observable(context.data).setProperty("built_contents",t.message)}refreshIframe("iframe-preview")}),$.templates("#template_preview").link("#preview-window",context.data)}),$(function(){formData={initialized:!1,condition:{condition:[],add:function(t){t=t||"",$.observable(this.condition).insert(this.condition.length,{category:t,key:"",condition:{selected:[],text:"",match:"",not_exists:"0",from:"",to:""},error:{}})},remove:function(t){$.observable(this.condition).remove(t)},reset:function(t){$.observable(this.condition[t]).setProperty("key",""),this.resetKey(t)},resetKey:function(t){$.observable(this.condition[t].condition).setProperty({text:"",match:"",not_exists:"0",selected:[]})},initialize:function(t){$.each(t,function(t,e){e.error={},void 0===e.condition.selected&&(e.condition.selected=[])}),$.observable(this.condition).refresh(t)},clear:function(){$.observable(this.condition).refresh([])},options:function(){return __condition||{}}},error:{attribute:{}},token:$("#token").val(),clearError:function(){var t=this;$.each(this.error,function(e,o){$.observable(t.error).setProperty(e,"")}),$.each(this.condition.condition,function(e,o){$.observable(t.condition.condition[e].error).setProperty({category:"",key:"",selected:"",text:"",match:"",not_exists:"",duration:""})}),$.each($("div.dropdown"),function(t,e){$(this).removeClass("error")})},setError:function(e){e&&(this._setError(e),e.token&&$.observable(t).setProperty("error",e.token),$.each($("select.error+div.dropdown"),function(t,e){$(this).addClass("error")}))},_setError:function(t){var e=this;$.each(t,function(t,o){"condition"===t?$.each(o,function(t,o){"object"==$.type(o)?$.each(o,function(o,n){$.observable(e.condition.condition[t].error).setProperty(o,n)}):$.observable(e.error).setProperty("condition",o)}):$.observable(e.error).setProperty(t,o)})},initialize:function(t){var e=this;$.each(t.detail,function(t,o){$.observable(e).setProperty(t,o)}),this.condition.initialize(t.conditions),$.observable(this).setProperty("initialized",!0)},set:function(t){var e=this;$.each(t,function(t,o){$.observable(e).setProperty(t,o)})},initial:!1,setCondition:function(t,e){var o=this;$.each(e,function(e,n){$.observable(o.condition.condition[t].condition).setProperty(e,n)})},qs:function(){return{condition:formData._qs(),attribute:{ranking_flag:formData.ranking_flag||"0",ranking_method:formData.ranking_method||"view",ranking_term:formData.ranking_term||"daily",ranking_count:formData.ranking_count||"10"}}},_qs:function(){var t=[];return $.each(formData.condition.condition,function(e,o){t.push({category:o.category,key:o.key,condition:o.condition})}),t},sort_column:null,sort_order:null,setSort:function(t,e){this.sort_column=t,this.sort_order=(e+1)%3},clearSort:function(){this.sort_column=null,this.sort_order=null}};var t={error:null,notice:null,clear:function(){$.observable(this).setProperty("error",null),$.observable(this).setProperty("notice",null),formData.clearError()},setError:function(t){var e=this;$.each(t,function(t,o){$.observable(e).setProperty("error",o)})},setNotice:function(t){$.observable(this).setProperty("notice",t)}};var e,o={lineNumbers:!0,indentUnit:4,autoCloseTags:!0,foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],mode:"xdata",lineWrapping:!0,scrollbarStyle:"simple",value:""};function n(){$.ajax({url:API_PREFIX+"/measurementMail/contents/"+SITE_ID+"/"+$("#schedule_id").val()+"/"+$("#contents_id").val()+"?mail_template_id="+$("#mail_template_id").val(),method:"GET",data_type:"json",timeout:AJAX_TIMEOUT,error:function(e,o,n){var r=JSON.parse(e.responseText);t.setError(r.messages.message),showErrorAlert(t.error,"div.panel-body.success")},success:function(t){context.editor.html_editor&&null!=t.html_body&&context.editor.html_editor.setValue(t.html_body),context.editor.text_editor&&null!=t.text_body&&context.editor.text_editor.setValue(t.text_body),$.observable(context.data).setProperty("editing",0),$.observable(context.data.block_num).setProperty(t.set_num)},complete:function(){}})}CodeMirror.defineMode("xdata",function(t,e){return CodeMirror.overlayMode(CodeMirror.getMode(t,e.backdrop||"text/html"),{token:function(t,e){var o;if(t.match("{{"))for(;null!=(o=t.next());)if("}"==o&&"}"==t.next())return t.eat("}"),"xdata";for(;null!=t.next()&&!t.match("{{",!1););return null}})}),$(".editor-tab li > a[has-editor]").each(function(t,e){var n=$(e).attr("has-editor");if(void 0===context.editor[n]){var r=document.getElementById(n);void 0===r.value&&(r.value=r.textContent,console.log("textarea.value was undefined")),context.editor[n]=CodeMirror.fromTextArea(r,o),context.editor[n].on("change",function(t,e){$.observable(context.data).setProperty({main_contents:t.getValue()}),$.observable(context.data).setProperty("editing",1)})}}),$(document).on("shown.bs.tab",".editor-tab li",function(t){var e=$(t.target).attr("has-editor");void 0!==e&&(context.current_editor=context.editor[e],context.current_editor.refresh(),$.observable(context.data).setProperty({main_contents:context.current_editor.getValue()}))}).on("click","#output .pulldown ul.dropdown-menu li",function(t){var e={};e[$(this).parents("div.btn-group").attr("name")]=$(this).attr("value"),$.observable(context.data.block_num).setProperty(e),$.observable(context.data).setProperty("editing",1),t.preventDefault()}).on("click","div.editor-save button",function(e){var o=$(this);formData.clearError();var r=context.editor.html_editor?context.editor.html_editor.getValue():"",i=context.editor.text_editor?context.editor.text_editor.getValue():"",a=assignObjects({context:{html_body:r,text_body:i,html_preview:$.templates(replaceKeyword(r)).render(context.data),text_preview:$.templates(replaceKeyword('<span style="white-space: pre-line;">'+$("<span/>").text(i).html()+"</span>")).render(context.data),set_num:context.data.block_num},contents_id:$("#contents_id").val(),token:$("#token").val(),from_test_mail:"0"},formData.qs());$("div.CodeMirror").removeClass("error"),$.ajax({url:API_PREFIX+"/measurementMail/updateOutput/"+SITE_ID+"/"+$("#schedule_id").val(),method:"POST",data:$.param(JSON.parse(JSON.stringify(a))),data_type:"json",timeout:AJAX_TIMEOUT,error:function(e,o,n){var r=JSON.parse(e.responseText);void 0!==r.detail.context?(t.setError(r.detail.context),"string"==typeof r.detail.context.html_body&&($("#html div.CodeMirror").addClass("error"),$("#tab_html").trigger("click")),"string"==typeof r.detail.context.text_body&&($("#text div.CodeMirror").addClass("error"),$("#tab_text").trigger("click")),$(".modal-content").html($("#error_dialog").render(r.detail.context)),$("#modal_popup").modal("show")):void 0!==r.messages.message&&(t.setError(r.messages.message),formData.setError(r.detail),$("#tab_output").trigger("click"),showErrorAlert(t.error,"div.panel-body.success"))},success:function(t){showSuccessAlert(t.message,"div.panel-body.success"),$.observable(context.data).setProperty("editing",0),void 0!==t.contents_id&&("-"===$("#contents_id").val()&&document.location.replace(URL_PREFIX+"/measurementMail/output/"+$("#schedule_id").val()+"/"+t.contents_id),$("#contents_id").val(t.contents_id)),o.hasClass("edit_finish")?document.location.href=URL_PREFIX+"/measurementMail/mail/"+$("#schedule_id").val():n()},complete:function(){}}),e.preventDefault()}).on("click",".mail-select button",function(t){$.observable(context.data).setProperty("mail_type",$(t.target).text())}).on("click","#go_template",function(t){document.location.href=URL_PREFIX+"/measurementMail/template/"+$("#schedule_id").val()+"/"+$("#contents_id").val(),t.preventDefault()}),$("iframe").on("load",function(t){$("body,html",$(this).contents()).scrollTop(scrollTop)}),$(window).on("beforeunload",function(t){if(1===context.data.editing)return"編集した内容は破棄されます。"}),$.when($.ajax({url:API_PREFIX+"/reportAnalysisItem/conditionMaster/"+SITE_ID,method:"GET",data_type:"json",timeout:AJAX_TIMEOUT,error:function(e,o,n){var r=JSON.parse(e.responseText);t.setError(r.messages.message),formData.setError(r.detail),showErrorAlert(t.error)},success:function(t){formData.condition.options=function(){return t}},complete:function(){}}),n(),void $.ajax({url:API_PREFIX+"/measurementMail/ranking/"+SITE_ID+"/"+$("#schedule_id").val()+"/"+$("#contents_id").val(),method:"GET",data_type:"json",timeout:AJAX_TIMEOUT,error:function(e,o,n){var r=JSON.parse(e.responseText);t.setError(r.messages.message),formData.setError(r.detail),showErrorAlert(t.error)},success:function(t){formData.initialize(t),e&&e()},complete:function(){}})).done(function(){$.templates("#template_ranking").link("#ranking",formData)}),$(document).on("click","#ranking_method ul.dropdown-menu li, #ranking_term ul.dropdown-menu li, #ranking_count ul.dropdown-menu li",function(t){t.preventDefault();var e=$(t.target),o=e.parents("ul").attr("name"),n=e.attr("value"),r=$.view($(this).parent()).data;"ranking_method"==o&&formData.condition.condition.length>0&&n!=r[o]?($(".modal-content").html($("#confirm_dialog").render({})),$("#modal_popup").modal("show"),$("#popup_submit").on("click",function(t){formData.condition.clear(),$.observable(r).setProperty(o,n),$.observable(context.data).setProperty("editing",1),$("#modal_popup").modal("hide")})):($.observable(r).setProperty(o,n),$.observable(context.data).setProperty("editing",1))}).on("click","#add_condition",function(){var t=formData.ranking_method;return t.match(/^order_/)&&(t="order"),formData.condition.add(t),!1}).on("click",".remove_condition a.search_condition_remove",function(t,e){return formData.condition.remove($.view(this).index),!1}).on("change","select.condition_key",function(t,e){formData.condition.resetKey($.view(this).getIndex())}).on("change","select.condition_category",function(t,e){formData.condition.reset($.view(this).getIndex())})});